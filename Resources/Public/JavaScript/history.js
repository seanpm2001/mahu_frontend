const history=function(e=""){let t=[],r=!1,i={bookmarks:[],visitedSites:[],queries:[],trackedQueries:[],settings:{}};{let t=localStorage.getItem("history"+e);if(t)try{i=JSON.parse(t)}catch(e){console.error(e)}}const s=function(){i&&localStorage.setItem("history"+e,JSON.stringify(i))},n=function(e){let t=!1,r=i.bookmarks.length;for(let s=0;s<r;++s){if(i.bookmarks[s].id==e.id){t=!0;break}}return t},o=function(e,r,i,s){let n=-1;for(let o=0;o<t.length;++o){let a=t[o];if(a.type==e&&a.eventType==r&&a.handler==i&&a.scope==s){n=o;break}}return n},a=function(e,r,i){t.forEach(function(t){if((t.type==e||t.type==history.entryTypes.ALL)&&(t.eventType&&t.eventType==i||t.eventType==history.eventTypes.ALL||!t.eventType))try{t.handler.call(t.scope,e,r,i)}catch(e){console.error(e)}})};return{isEmpty:function(){return!(i&&Array.isArray(i.bookmarks)&&Array.isArray(i.visitedSites)&&Array.isArray(i.queries)&&Array.isArray(i.trackedQueries)&&i.bookmarks.length+i.visitedSites.length+i.queries.length+i.trackedQueries.length!=0)},clear:function(e){if(r)if(e){let t=function(e){return history.entryTypes.BOOKMARK==e?i.bookmarks:history.entryTypes.QUERY==e?i.queries:history.entryTypes.PAGEVISIT==e?i.visitedSites:history.entryTypes.TRACKEDQUERY==e?i.trackedQueries:void 0}(e);null!=t&&(t.length=0,s(),a(e,null,history.eventTypes.REMOVE))}else i={bookmarks:[],visitedSites:[],queries:[],trackedQueries:[],settings:{}},s(),a(history.entryTypes.ALL,null,history.eventTypes.REMOVE);else a(history.entryTypes.ALL,Localization.getString("history.error.disabled"),history.eventTypes.ERROR)},addListener:function(e,r,i,s){if(!$.isFunction(i))return console.error("The event handler must be a function!"),!1;return-1==o(e,r,i,s)?(t.push({type:e,eventType:r,handler:i,scope:s}),!0):(console.info("Listener already has been registered!"),!1)},removeListener:function(e,r,i,s){let n=o(e,r,i,s);return-1!=n&&(t.splice(n,1),!0)},enable:function(){r=!0,console.info("history: tracking enabled")},addBookmark:function(e){if(r)return!n(e)&&(i.bookmarks.push(e),s(),a(history.entryTypes.BOOKMARK,e,history.eventTypes.ADD),!0);a(history.entryTypes.ALL,Localization.getString("history.error.disabled"),history.eventTypes.ERROR)},removeBookmark:function(e){if(!r)return void a(history.entryTypes.ALL,Localization.getString("history.error.disabled"),history.eventTypes.ERROR);let t=-1,n=i.bookmarks.length;for(let r=0;r<n;++r)if(i.bookmarks[r].id==e.id){t=r;break}return-1!=t&&(i.bookmarks.splice(t,1),s(),a(history.entryTypes.BOOKMARK,e,history.eventTypes.REMOVE),!0)},isBookmarked:n,getBookmarks:function(){return[].concat(i.bookmarks)},addPageVisit:function(e){if(!r)return;let t=!1,n=i.visitedSites.length;for(let r=0;r<n;++r){let n=i.visitedSites[r];if(n.id==e.id){n.timestamp=+new Date,s(),t=!0;break}}if(t)return!1;if(i.visitedSites.push(e),i.visitedSites.length>20){let e=-1,t=+new Date;for(let r=0;r<n+1;++r){let s=i.visitedSites[r];s.timestamp<t&&(e=r,t=s.timestamp)}i.visitedSites.splice(e,1)}return s(),a(history.entryTypes.PAGEVISIT,e,history.eventTypes.ADD),!0},removePageVisit:function(e){if(!r)return void a(history.entryTypes.ALL,Localization.getString("history.error.disabled"),history.eventTypes.ERROR);let t=-1,n=i.visitedSites.length;for(let r=0;r<n;++r)if(i.visitedSites[r].id==e.id){t=r;break}return-1!=t&&(i.visitedSites.splice(t,1),s(),a(history.entryTypes.PAGEVISIT,e,history.eventTypes.REMOVE),!0)},getPageVisits:function(){return[].concat(i.visitedSites)},addTrackedQuery:function(e){if(!r)return;let t=i.trackedQueries.length;if(t>0){let r=i.trackedQueries[t-1];e.q.default.term&&r.q.default.term&&e.q.default.term==r.q.default.term?i.trackedQueries.pop():r.q.default==e.q.default&&i.trackedQueries.pop(),i.trackedQueries.push(e)}else i.trackedQueries.push(e);return i.trackedQueries.length>20&&i.trackedQueries.splice(0,1),s(),a(history.entryTypes.TRACKEDQUERY,e,history.eventTypes.ADD),!0},removeTrackedQuery:function(e){if(!r)return void a(history.entryTypes.ALL,Localization.getString("history.error.disabled"),history.eventTypes.ERROR);let t=-1,n=i.trackedQueries.length;for(let r=0;r<n;++r)if(i.trackedQueries[r].timestamp==e.timestamp){t=r;break}return-1!=t&&(i.trackedQueries.splice(t,1),s(),a(history.entryTypes.TRACKEDQUERY,e,history.eventTypes.REMOVE),!0)},getTrackedQueries:function(){return[].concat(i.trackedQueries)},addQuery:function(e){if(r)return i.queries.push(e),s(),a(history.entryTypes.QUERY,e,history.eventTypes.ADD),!0;a(history.entryTypes.ALL,Localization.getString("history.error.disabled"),history.eventTypes.ERROR)},removeQuery:function(e){if(!r)return void a(history.entryTypes.ALL,Localization.getString("history.error.disabled"),history.eventTypes.ERROR);let t=-1,n=i.queries.length;for(let r=0;r<n;++r)if(i.queries[r].timestamp==e.timestamp){t=r;break}return-1!=t&&(i.queries.splice(t,1),s(),a(history.entryTypes.QUERY,e,history.eventTypes.REMOVE),!0)},getQueries:function(){return[].concat(i.queries)},getSetting:function(e){if(i.settings||(i.settings={}),i.settings[e])return i.settings[e]},setSetting:function(e,t){r&&(i.settings||(i.settings={}),i.settings[e]=t,s())}}};Object.defineProperties(history,{entryTypes:{value:Object.defineProperties({},{BOOKMARK:{value:"bookmark",configurable:!1,enumerable:!0,writable:!1},QUERY:{value:"query",configurable:!1,enumerable:!0,writable:!1},TRACKEDQUERY:{value:"trackedquery",configurable:!1,enumerable:!0,writable:!1},PAGEVISIT:{value:"pagevisit",configurable:!1,enumerable:!0,writable:!1},ALL:{value:"all",configurable:!1,enumerable:!0,writable:!1}}),writeable:!1,enumerable:!0,configurable:!1}}),Object.defineProperties(history,{eventTypes:{value:Object.defineProperties({},{ADD:{value:"add",configurable:!1,enumerable:!0,writable:!1},REMOVE:{value:"remove",configurable:!1,enumerable:!0,writable:!1},ALL:{value:"all",configurable:!1,enumerable:!0,writable:!1},ERROR:{value:"error",configurable:!1,enumerable:!0,writable:!1}}),writeable:!1,enumerable:!0,configurable:!1}});