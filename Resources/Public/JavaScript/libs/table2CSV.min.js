jQuery.fn.table2CSV=function(r){r=jQuery.extend({separator:",",header:[],headerSelector:"th",columnSelector:"td",delivery:"popup",transform_gt_lt:!0},r);var i=[],e=r.header.length,t=[];if(0<e)for(var n=0;n<e;n++)t[t.length]=s(r.header[n]);else $(this).filter(":visible").find(r.headerSelector).each(function(){"none"!=$(this).css("display")&&(t[t.length]=s($(this).html()))});if(h(t),$(this).find("tr").each(function(){var e=[];$(this).filter(":visible").find(r.columnSelector).each(function(){"none"!=$(this).css("display")&&(e[e.length]=s($(this).html()))}),h(e)}),"popup"==r.delivery){var o=i.join("\n");return r.transform_gt_lt&&(o=d(o)),l=o,(c=window.open("","csv","height=400,width=600")).document.write("<html><head><title>CSV</title>"),c.document.write("</head><body >"),c.document.write('<textArea cols=70 rows=15 wrap="off" >'),c.document.write(l),c.document.write("</textArea>"),c.document.write("</body></html>"),c.document.close(),!0}if("download"==r.delivery){o=i.join("\n");r.transform_gt_lt&&(o=d(o));var a="data:text/csv;charset=utf8,"+encodeURIComponent(o);return window.open(a),!0}var l,c;o=i.join("\n");return r.transform_gt_lt&&(o=d(o)),o;function d(e){var t=new RegExp(/&gt;/g);e=e.replace(t,">"),t=new RegExp(/&lt;/g);return e=e.replace(t,"<")}function h(e){var t=e.join("");if(0<e.length&&""!=t){var n=e.join(r.separator);i[i.length]=n}}function s(e){var t=new RegExp(/["]/g),n=e.replace(t,'""');t=new RegExp(/\<[^\<]+\>/g);return""==(n=(n=n.replace(t,"")).replace(/&nbsp;/gi," "))?"":'"'+n.trim()+'"'}};